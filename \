#include "ErrorHandler.hpp"
#include "IOTools.hpp"
#include "StrTools.hpp"

#include "PBar.hpp"

#include "GUIDistrCutter2D.hpp"

void TimingDM()
{
	gStyle->SetOptStat(0);
   TDirectory::AddDirectory(kFALSE);
   gErrorIgnoreLevel = kWarning;
   ROOT::EnableImplicitMT();

   const std::string heatmapIdentifierName = "Timing heatmap";

   CppTools::PrintInfo("List of runs in data/Real directory");
   system("ls data/Real/");

   CppTools::Print("Choose the run from the above ant type it in");
   std::string runName = "Run14HeAu200";
   //std::cout << ">> ";
   //std::cin >> runName;

   const std::string realInputFileName = "data/Real/" + runName + "/SingleTrack/sum.root";
   const std::string simInputFileName = "data/PostSim/" + runName + "/SingleTrack/all.root";
   CppTools::CheckInputFile(realInputFileName);
   CppTools::CheckInputFile(simInputFileName);
   TFile realInputFile(realInputFileName.c_str());
   TFile simInputFile(simInputFileName.c_str());

   CppTools::PrintInfo("List of heatmaps in " + realInputFileName + " file");
   realInputFile.ls((heatmapIdentifierName + ":*").c_str());

   CppTools::Print("Type in the detector name");
   std::string detectorName;
   std::cout << ">> ";
   std::cin >> std::ws;
   std::getline(std::cin, detectorName);

   TH3D *realHist = static_cast<TH3D *>
      (realInputFile.Get((heatmapIdentifierName + ": " + detectorName).c_str()));

   if (!realHist) 
   {
      CppTools::PrintError("No histogram named" + heatmapIdentifierName + ": " + detectorName + 
                           " in file " + realInputFileName);
   }

   TH2D meanTimeHist("mean T in real data", "", 
                     realHist->GetYaxis()->GetNbins(), 
                     realHist->GetYaxis()->GetBinLowEdge(1), 
                     realHist->GetYaxis()->GetBinUpEdge(realHist->GetYaxis()->GetNbins()),
                     realHist->GetZaxis()->GetNbins(), 
                     realHist->GetZaxis()->GetBinLowEdge(1), 
                     realHist->GetZaxis()->GetBinUpEdge(realHist->GetZaxis()->GetNbins()));

   TH2D sigmaTimeHist("sigma T in real data", "", 
                      realHist->GetYaxis()->GetNbins(), 
                      realHist->GetYaxis()->GetBinLowEdge(1), 
                      realHist->GetYaxis()->GetBinUpEdge(realHist->GetYaxis()->GetNbins()),
                      realHist->GetZaxis()->GetNbins(), 
                      realHist->GetZaxis()->GetBinLowEdge(1), 
                      realHist->GetZaxis()->GetBinUpEdge(realHist->GetZaxis()->GetNbins()));

   const std::string outputDir = "output/TimingDeadmaps/" + detectorName;
   system(("mkdir -p " + outputDir).c_str());

   ProgressBar pBar("BLOCK", "Preparing the heatmap", PBarColor::BOLD_MAGENTA);

   const double numberOfIterations = static_cast<double>(realHist->GetYaxis()->GetNbins()*
                                                         realHist->GetZaxis()->GetNbins());

   for (int i = 1; i <= realHist->GetYaxis()->GetNbins(); i++)
   {
      for (int j = 1; j <= realHist->GetZaxis()->GetNbins(); j++)
      {
         pBar.Print(static_cast<double>(i + j - 2)/numberOfIterations);

         // distribution for a single smallest unit of a detector (tower, slat, strip, etc.)
         TH1D *distrTime = realHist->
            ProjectionX((realHist->GetName() + std::to_string(i) + std::to_string(j)).c_str(), 
                        i, i, j, j);

         //CppTools::Print(i, j, distrTime->Integral(1, distrTime->GetXaxis()->GetNbins());
         // removing units with insufficient statistics
         if (distrTime->Integral(1, distrTime->GetXaxis()->GetNbins()) < 100.)
         {
            //meanTimeHist.SetBinContent(i, j, -9999.);
            //sigmaTimeHist.SetBinContent(i, j, -9999.);
            continue;
         }

         // usually the time is distributed by gausses of pions, kaons, and protons
         // by taking maximum value we extract the value close to the center of pions signal
         const int maximumBin = distrTime->GetMaximumBin();

         TCanvas canv(("canv" + std::to_string(i) + std::to_string(j)).c_str(), "", 400, 400);

         // approximation of t-t_exp for pi+
         TF1 gausFit("gaus fit", "gaus");
         gausFit.SetParameter(0, distrTime->GetBinContent(maximumBin));
         gausFit.SetParameter(1, distrTime->GetXaxis()->GetBinCenter(maximumBin));
         gausFit.SetParLimits(1, distrTime->GetXaxis()->GetBinCenter(maximumBin - 3), 
                              distrTime->GetXaxis()->GetBinCenter(maximumBin + 3));
         gausFit.SetParameter(2, distrTime->GetXaxis()->GetBinWidth(maximumBin)*5.);
         gausFit.SetRange(distrTime->GetXaxis()->GetBinLowEdge(maximumBin - 10), 
                          distrTime->GetXaxis()->GetBinUpEdge(maximumBin + 5));

         distrTime->Fit(&gausFit, "RQMBN");
         meanTimeHist.SetBinContent(i, j, gausFit.GetParameter(1));
         sigmaTimeHist.SetBinContent(i, j, fabs(gausFit.GetParameter(2)));

         gPad->Add(distrTime);
         gPad->Add(&gausFit, "SAME");

         canv.SaveAs((outputDir + "/fit_" + std::to_string(i) + "_" + 
                      std::to_string(j) + ".png").c_str());
      }
   }

   pBar.Clear();
   CppTools::PrintInfo("Preparing the heatmap: done");

   /*
   TH2D *simHist = static_cast<TH2D *>
      (simInputFile.Get((heatmapIdentifierName + ": " + detectorName).c_str()));

   if (!simHist) 
   {
      CppTools::PrintError("No histogram named" + heatmapIdentifierName + ": " + 
                           detectorName + " in file " + simInputFileName);
   }
   */

	TCanvas *canv = new TCanvas("", "", 900, 900);
   
   GUIDistrCutter2D::AddHistogram(&meanTimeHist);
   GUIDistrCutter2D::AddHistogram(&sigmaTimeHist);
   //GUIDistrCutter2D::AddHistogram(static_cast<TH2D *>(simHist->Clone("sim")));
   system(("mkdir -p data/Parameters/TimingDeadmaps/" + runName).c_str());

   while (detectorName.find(" ") < detectorName.size())
   {
      const unsigned int spacePos = detectorName.find(" ");
      detectorName.erase(spacePos, 1);
   }

   const std::string outputCutsFileName = "data/Parameters/TimingDeadmaps/" + 
                                          runName + "/TimingDeadmap" + detectorName + ".txt";

   if (CppTools::FileExists(outputCutsFileName))
   {
      GUIDistrCutter2D::ReadCutAreas(outputCutsFileName);
   }
   GUIDistrCutter2D::SetOutputFile(outputCutsFileName);

	gPad->AddExec("exec", "GUIDistrCutter2D::Exec()");
}
